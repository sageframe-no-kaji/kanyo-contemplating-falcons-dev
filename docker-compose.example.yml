# docker-compose.example.yml
#
# This is an EXAMPLE file intended for humans.
# Copy it to `docker-compose.yml` and edit paths, names, and configs as needed.
#
# It works with:
#   - docker compose (by hand, CLI-first)
#   - Portainer (Stack → Web editor)
#
# Philosophy:
# - One service = one camera
# - Same image, different config + data directories
# - Explicit names so nothing feels “magic”
#

version: "3.9"

services:

  # =========================
  # Camera 1
  # =========================
  cam-1:
    # Build the image from the local Dockerfile
    # If you already built/pushed the image, you can remove this
    build: .

    # Image name used by both services
    image: kanyo:latest

    # Explicit container name for easy `docker ps` / logs / debugging
    container_name: kanyo-cam-1

    # Shared environment variables (credentials, endpoints, etc.)
    env_file:
      - .env.docker

    volumes:
      # Camera-specific configuration file (includes stream URL, channels, topics)
      # This is the MAIN thing you change per camera
      - ./config/cam-1.yaml:/app/config.yaml:ro

      # Persistent data directories
      # These should usually live outside the repo
      - ${KANYO_CAM1_ROOT:-./data/cam-1}/clips:/app/clips
      - ${KANYO_CAM1_ROOT:-./data/cam-1}/logs:/app/logs

    environment:
      # Ensures logs are flushed immediately (important for Docker logs)
      - PYTHONUNBUFFERED=1

    # Restart unless explicitly stopped by the user
    restart: unless-stopped

    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"


  # =========================
  # Camera 2
  # =========================
  cam-2:
    build: .
    image: kanyo:latest
    container_name: kanyo-cam-2

    env_file:
      - .env.docker

    volumes:
      # Camera-specific configuration file (includes stream URL, channels, topics)
      - ./config/cam-2.yaml:/app/config.yaml:ro

      # Persistent data directories
      - ${KANYO_CAM2_ROOT:-./data/cam-2}/clips:/app/clips
      - ${KANYO_CAM2_ROOT:-./data/cam-2}/logs:/app/logs

    environment:
      - PYTHONUNBUFFERED=1

    restart: unless-stopped

    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"


# =========================
# HOW TO USE (BY HAND)
# =========================
#
# 1. Copy this file:
#      cp docker-compose.example.yml docker-compose.yml
#
# 2. Set up .env.docker with your bot token:
#      cp .env.docker.example .env.docker
#      # Edit and add: TELEGRAM_BOT_TOKEN=your_token_here
#
# 3. Create camera configs with stream URLs and channels:
#      # Option A: Use existing test configs
#      ln -s test_config_harvard.yaml config/cam-1.yaml
#      ln -s test_config_nsw.yaml config/cam-2.yaml
#
#      # Option B: Create new configs (copy from examples)
#      mkdir -p config
#      cp test_config_harvard.yaml config/cam-1.yaml
#      # Edit cam-1.yaml:
#      #   video_source: your_youtube_url
#      #   telegram_channel: @your_channel
#      #   ntfy_topic: your_topic
#
# 4. (Optional) Set data roots in .env.docker:
#      KANYO_CAM1_ROOT=/tank/kanyo/cam-1
#      KANYO_CAM2_ROOT=/tank/kanyo/cam-2
#
# 5. Start everything:
#      docker compose up -d
#
# =========================
# NOTIFICATION ARCHITECTURE
# =========================
# - Bot token: .env.docker (shared secret, single bot for all cameras)
# - Channels/topics: Per-camera YAML config files
# - Each camera posts to its own Telegram channel and ntfy topic
#
# This allows one .env.docker to work with multiple cameras,
# each posting to different channels.
#
# =========================
#
# PORTAINER:
# - Paste this file into a Stack
# - Upload the config files and .env.docker
# - Set additional env vars in the Stack if desired
#
# This file is intentionally verbose.
# Clarity > cleverness.

# Docker Compose for VAAPI (Intel iGPU) deployment
# Requires Intel integrated graphics with VAAPI support

x-kanyo-vaapi-service: &kanyo-vaapi-service
  image: ghcr.io/sageframe-no-kaji/kanyo-contemplating-falcons-dev:vaapi
  pull_policy: if_not_present
  env_file: .env
  shm_size: '2gb'
  environment:
    - PYTHONUNBUFFERED=1
    - LIBVA_DRIVER_NAME=iHD  # Intel iGPU driver
  volumes:
    # Mount source code from host - overrides baked-in code in image
    - ${KANYO_CODE_ROOT:-/opt/services/kanyo-code}/src:/app/src:ro
  devices:
    - /dev/dri:/dev/dri  # Intel GPU device access for VAAPI
  restart: unless-stopped
  logging:
    driver: "json-file"
    options:
      max-size: "10m"
      max-file: "3"

services:
  harvard-vaapi:
    <<: *kanyo-vaapi-service
    container_name: kanyo-harvard-vaapi
    volumes:
      # Mount source code from host - overrides baked-in code in image
      - ${KANYO_CODE_ROOT:-/opt/services/kanyo-code}/src:/app/src:ro
      # Config, clips, and logs all from stream directory
      - ${KANYO_CAM1_ROOT:-./data/harvard}/config.yaml:/app/config.yaml:ro
      - ${KANYO_CAM1_ROOT:-./data/harvard}/clips:/app/clips
      - ${KANYO_CAM1_ROOT:-./data/harvard}/logs:/app/logs

  nsw-vaapi:
    <<: *kanyo-vaapi-service
    container_name: kanyo-nsw-vaapi
    volumes:
      # Mount source code from host - overrides baked-in code in image
      - ${KANYO_CODE_ROOT:-/opt/services/kanyo-code}/src:/app/src:ro
      # Config, clips, and logs all from stream directory
      - ${KANYO_CAM2_ROOT:-./data/nsw}/config.yaml:/app/config.yaml:ro
      - ${KANYO_CAM2_ROOT:-./data/nsw}/clips:/app/clips
      - ${KANYO_CAM2_ROOT:-./data/nsw}/logs:/app/logs

{% extends "base.html" %}

{% block title %}{{ stream.name }} - Configuration{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8 max-w-4xl">
    <!-- Back Link -->
    <a href="/streams/{{ stream.id }}" class="text-zinc-400 hover:text-white mb-4 inline-block">
        ‚Üê Back to Stream
    </a>

    <!-- Header -->
    <header class="mb-8">
        <h1 class="text-3xl font-bold">Configuration</h1>
        <p class="text-zinc-400 mt-2">{{ stream.name }}</p>
    </header>

    <!-- Configuration Form -->
    <form id="config-form"
          method="POST"
          hx-put="/api/streams/{{ stream.id }}/config"
          hx-target="#save-feedback"
          hx-swap="innerHTML"
          hx-encoding="multipart/form-data"
          class="space-y-6">

        <!-- Feedback Message (fixed position at top) -->
        <div id="save-feedback" class="mb-4"></div>

        <!-- Stream & Detection Section -->
        <section class="bg-zinc-800 rounded-lg p-6">
            <h2 class="text-xl font-semibold mb-4">Stream & Detection</h2>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2">Stream Name</label>
                    <input type="text"
                           name="stream_name"
                           value="{{ config.stream_name }}"
                           class="w-full bg-zinc-700 border border-zinc-600 rounded px-3 py-2 focus:outline-none focus:border-zinc-500">
                </div>

                <div>
                    <label class="block text-sm font-medium mb-2">Video Source</label>
                    <input type="text"
                           name="video_source"
                           value="{{ config.video_source }}"
                           class="w-full bg-zinc-700 border border-zinc-600 rounded px-3 py-2 focus:outline-none focus:border-zinc-500"
                           required>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Detection Confidence</label>
                        <input type="number"
                               name="detection_confidence"
                               value="{{ config.detection_confidence }}"
                               step="0.01"
                               min="0"
                               max="1"
                               class="w-full bg-zinc-700 border border-zinc-600 rounded px-3 py-2 focus:outline-none focus:border-zinc-500">
                    </div>

                    <div>
                        <label class="block text-sm font-medium mb-2">Detection Confidence (IR/Night)</label>
                        <input type="number"
                               name="detection_confidence_ir"
                               value="{{ config.detection_confidence_ir or '' }}"
                               step="0.01"
                               min="0"
                               max="1"
                               placeholder="Leave empty to use day threshold"
                               class="w-full bg-zinc-700 border border-zinc-600 rounded px-3 py-2 focus:outline-none focus:border-zinc-500">
                        <small class="text-xs text-zinc-400 mt-1 block">Lower threshold for infrared/night footage (optional)</small>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Frame Interval</label>
                        <input type="number"
                               name="frame_interval"
                               value="{{ config.frame_interval }}"
                               min="1"
                               class="w-full bg-zinc-700 border border-zinc-600 rounded px-3 py-2 focus:outline-none focus:border-zinc-500">
                    </div>

                    <div>
                        <label class="block text-sm font-medium mb-2">Timezone</label>
                        <select name="timezone"
                                class="w-full bg-zinc-700 border border-zinc-600 rounded px-3 py-2 focus:outline-none focus:border-zinc-500">
                            <option value="UTC" {% if config.timezone == 'UTC' %}selected{% endif %}>UTC (GMT+0)</option>
                            <option value="America/New_York" {% if config.timezone == 'America/New_York' %}selected{% endif %}>US Eastern (GMT-5)</option>
                            <option value="America/Chicago" {% if config.timezone == 'America/Chicago' %}selected{% endif %}>US Central (GMT-6)</option>
                            <option value="America/Denver" {% if config.timezone == 'America/Denver' %}selected{% endif %}>US Mountain (GMT-7)</option>
                            <option value="America/Los_Angeles" {% if config.timezone == 'America/Los_Angeles' %}selected{% endif %}>US Pacific (GMT-8)</option>
                            <option value="Europe/London" {% if config.timezone == 'Europe/London' %}selected{% endif %}>London (GMT+0)</option>
                            <option value="Europe/Paris" {% if config.timezone == 'Europe/Paris' %}selected{% endif %}>Central Europe (GMT+1)</option>
                            <option value="Australia/Sydney" {% if config.timezone == 'Australia/Sydney' %}selected{% endif %}>Sydney (GMT+11)</option>
                            <option value="Australia/Melbourne" {% if config.timezone == 'Australia/Melbourne' %}selected{% endif %}>Melbourne (GMT+11)</option>
                            <option value="Australia/Brisbane" {% if config.timezone == 'Australia/Brisbane' %}selected{% endif %}>Brisbane (GMT+10)</option>
                            <option value="Australia/Perth" {% if config.timezone == 'Australia/Perth' %}selected{% endif %}>Perth (GMT+8)</option>
                            <option value="Pacific/Auckland" {% if config.timezone == 'Pacific/Auckland' %}selected{% endif %}>Auckland (GMT+13)</option>
                            <option value="Asia/Tokyo" {% if config.timezone == 'Asia/Tokyo' %}selected{% endif %}>Tokyo (GMT+9)</option>
                            <option value="Asia/Singapore" {% if config.timezone == 'Asia/Singapore' %}selected{% endif %}>Singapore (GMT+8)</option>
                        </select>
                        <p class="text-xs text-zinc-400 mt-1">Used for clip timestamps and log display</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- State Machine Section -->
        <section class="bg-zinc-800 rounded-lg p-6">
            <h2 class="text-xl font-semibold mb-4">State Machine</h2>

            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Exit Timeout (seconds)</label>
                        <input type="number"
                               name="exit_timeout"
                               value="{{ config.exit_timeout }}"
                               min="0"
                               class="w-full bg-zinc-700 border border-zinc-600 rounded px-3 py-2 focus:outline-none focus:border-zinc-500">
                    </div>

                    <div>
                        <label class="block text-sm font-medium mb-2">Roosting Threshold (seconds)</label>
                        <input type="number"
                               name="roosting_threshold"
                               value="{{ config.roosting_threshold }}"
                               min="0"
                               class="w-full bg-zinc-700 border border-zinc-600 rounded px-3 py-2 focus:outline-none focus:border-zinc-500">
                    </div>
                </div>

                <p class="text-sm text-zinc-400">
                    Note: Roosting threshold must be greater than exit timeout
                </p>
            </div>
        </section>

        <!-- Notifications Section -->
        <section class="bg-zinc-800 rounded-lg p-6">
            <h2 class="text-xl font-semibold mb-4">Notifications</h2>

            <div class="space-y-4">
                <div class="flex items-center gap-2">
                    <input type="checkbox"
                           name="telegram_enabled"
                           id="telegram_enabled"
                           {% if config.telegram_enabled %}checked{% endif %}
                           class="w-4 h-4 bg-zinc-700 border-zinc-600 rounded">
                    <label for="telegram_enabled" class="text-sm font-medium">Enable Telegram Notifications</label>
                </div>

                <div>
                    <label class="block text-sm font-medium mb-2">Telegram Channel</label>
                    <input type="text"
                           name="telegram_channel"
                           value="{{ config.telegram_channel or '' }}"
                           class="w-full bg-zinc-700 border border-zinc-600 rounded px-3 py-2 focus:outline-none focus:border-zinc-500">
                </div>
            </div>
        </section>

        <!-- Public Display Section -->
        <section class="bg-zinc-800 rounded-lg p-6">
            <h2 class="text-xl font-semibold mb-4">Public Display</h2>
            <p class="text-sm text-zinc-400 mb-4">Metadata shown on the public viewer site</p>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2">Short Name</label>
                    <input type="text"
                           name="display_short_name"
                           value="{{ config.get('display', {}).get('short_name', '') }}"
                           placeholder="e.g., Harvard"
                           class="w-full bg-zinc-700 border border-zinc-600 rounded px-3 py-2 focus:outline-none focus:border-zinc-500">
                    <p class="text-xs text-zinc-400 mt-1">Brief name for stream cards</p>
                </div>

                <div>
                    <label class="block text-sm font-medium mb-2">Location</label>
                    <input type="text"
                           name="display_location"
                           value="{{ config.get('display', {}).get('location', '') }}"
                           placeholder="e.g., Memorial Hall, Harvard University, Cambridge MA"
                           class="w-full bg-zinc-700 border border-zinc-600 rounded px-3 py-2 focus:outline-none focus:border-zinc-500">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Latitude</label>
                        <input type="number"
                               name="display_latitude"
                               value="{{ config.get('display', {}).get('coordinates', [None, None])[0] or '' }}"
                               step="0.000001"
                               placeholder="42.376235"
                               class="w-full bg-zinc-700 border border-zinc-600 rounded px-3 py-2 focus:outline-none focus:border-zinc-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Longitude</label>
                        <input type="number"
                               name="display_longitude"
                               value="{{ config.get('display', {}).get('coordinates', [None, None])[1] or '' }}"
                               step="0.000001"
                               placeholder="-71.115832"
                               class="w-full bg-zinc-700 border border-zinc-600 rounded px-3 py-2 focus:outline-none focus:border-zinc-500">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium mb-2">Species</label>
                    <input type="text"
                           name="display_species"
                           value="{{ config.get('display', {}).get('species', '') }}"
                           placeholder="e.g., Peregrine Falcon (Falco peregrinus)"
                           class="w-full bg-zinc-700 border border-zinc-600 rounded px-3 py-2 focus:outline-none focus:border-zinc-500">
                </div>

                <div>
                    <label class="block text-sm font-medium mb-2">Nest Status</label>
                    <textarea name="display_nest_status"
                              rows="2"
                              placeholder="e.g., Active nesting site with periodic occupancy"
                              class="w-full bg-zinc-700 border border-zinc-600 rounded px-3 py-2 focus:outline-none focus:border-zinc-500">{{ config.get('display', {}).get('nest_status', '') }}</textarea>
                </div>

                <div>
                    <label class="block text-sm font-medium mb-2">Maintainer</label>
                    <input type="text"
                           name="display_maintainer"
                           value="{{ config.get('display', {}).get('maintainer', '') }}"
                           placeholder="e.g., Harvard Faculty of Arts & Sciences"
                           class="w-full bg-zinc-700 border border-zinc-600 rounded px-3 py-2 focus:outline-none focus:border-zinc-500">
                </div>

                <div>
                    <label class="block text-sm font-medium mb-2">Maintainer URL</label>
                    <input type="url"
                           name="display_maintainer_url"
                           value="{{ config.get('display', {}).get('maintainer_url', '') }}"
                           placeholder="https://example.com"
                           class="w-full bg-zinc-700 border border-zinc-600 rounded px-3 py-2 focus:outline-none focus:border-zinc-500">
                </div>

                <div>
                    <label class="block text-sm font-medium mb-2">Description</label>
                    <textarea name="display_description"
                              rows="3"
                              placeholder="Brief description of the camera and location for public viewers"
                              class="w-full bg-zinc-700 border border-zinc-600 rounded px-3 py-2 focus:outline-none focus:border-zinc-500">{{ config.get('display', {}).get('description', '') }}</textarea>
                </div>
            </div>
        </section>

        <!-- Action Buttons -->
        <div class="flex gap-3 justify-end">
            <a href="/streams/{{ stream.id }}"
               class="bg-zinc-700 hover:bg-zinc-600 py-2 px-6 rounded transition">
                Cancel
            </a>
            <button type="submit"
                    name="action"
                    value="save"
                    class="bg-blue-600 hover:bg-blue-500 py-2 px-6 rounded transition font-medium disabled:opacity-50"
                    hx-disabled-elt="this">
                Save
            </button>
            <button type="submit"
                    name="action"
                    value="save_restart"
                    class="bg-green-600 hover:bg-green-500 py-2 px-6 rounded transition font-medium disabled:opacity-50"
                    hx-disabled-elt="this">
                Save & Restart
            </button>
        </div>
    </form>
</div>

<script>
// Debug HTMX events
document.body.addEventListener('htmx:afterSwap', function(evt) {
    console.log('HTMX swap completed:', evt.detail);
});
document.body.addEventListener('htmx:responseError', function(evt) {
    console.error('HTMX error:', evt.detail);
});
</script>
{% endblock %}

# ============================================================================
# Kanyo – Example config.yaml
# Tier 1 / Reference Configuration (Single Stream)
#
# This file is meant to be:
# - Human-readable
# - Easy to copy and modify by hand
# - Safe to use as a starting point
#
# Any value can be overridden with an environment variable:

# ─────────────────────────────────────────────────────────────────────────────
# Stream Identity (for Admin GUI)
# ─────────────────────────────────────────────────────────────────────────────
stream_name: "My Falcon Cam"       # Display name in admin UI
timezone: "UTC"                # IANA timezone name (e.g., "Australia/Sydney", "America/New_York")
#   KANYO_<KEY>
#   e.g. KANYO_VIDEO_SOURCE, KANYO_LOG_LEVEL
# ============================================================================


# ─────────────────────────────────────────────────────────────────────────────
# Stream & Detection
# ─────────────────────────────────────────────────────────────────────────────

# Live video source (YouTube, RTSP, file, etc.)
video_source: "https://www.youtube.com/watch?v=glczTFRRAK4"

# Detection sensitivity
detection_confidence: 0.5     # 0.0–1.0 (higher = fewer false positives)
frame_interval: 3             # Process every Nth frame

# YOLO model location (inside container)
model_path: "models/yolov8n.pt"

# Treat any detected animal as a valid target
detect_any_animal: true


# ─────────────────────────────────────────────────────────────────────────────
# State Machine
# ─────────────────────────────────────────────────────────────────────────────

# Timeouts are in seconds
exit_timeout: 90               # Seconds absent before departure (same for all states)
roosting_threshold: 1800       # 30 min - transition to roosting (notification only)

# Arrival confirmation (prevent false positives)
arrival_confirmation_seconds: 10   # Seconds to confirm arrival
arrival_confirmation_ratio: 0.3    # 30% of frames must detect

# Notifications
notify_on_startup: false       # Send notification if bird detected at startup


# ─────────────────────────────────────────────────────────────────────────────
# Detection Classes (COCO IDs)
# ─────────────────────────────────────────────────────────────────────────────

# Used when detect_any_animal = true
animal_classes:
  - 14  # bird
  - 15  # cat
  - 16  # dog
  - 17  # horse
  - 18  # sheep
  - 19  # cow
  - 20  # elephant
  - 21  # bear
  - 22  # zebra
  - 23  # giraffe


# ─────────────────────────────────────────────────────────────────────────────
# Clip Extraction & Storage
# ─────────────────────────────────────────────────────────────────────────────

# These paths are INSIDE the container
# (bind-mounted from the host or ZFS dataset)
clips_dir: "/app/clips"
log_file: "/app/logs/kanyo.log"

# Frame buffer for pre-event footage (seconds)
# Keeps recent frames in memory for perfect clip timing
# Memory usage: ~100KB per frame (e.g., 60s @ 30fps = ~180MB)
buffer_seconds: 60

# Clip timing (seconds)
clip_arrival_before: 15       # Seconds before arrival to include
clip_arrival_after: 30        # Seconds after arrival to include
clip_departure_before: 30     # Seconds before departure to include
clip_departure_after: 15      # Seconds after departure to include
clip_state_change_before: 15  # Seconds before state change
clip_state_change_after: 30   # Seconds after state change
clip_state_change_cooldown: 300  # Debounce for state change clips (5 min)

# Thumbnail capture
thumbnail_entrance_offset: 5
thumbnail_exit_offset: -10


# ─────────────────────────────────────────────────────────────────────────────
# Encoding & Compression
# ─────────────────────────────────────────────────────────────────────────────

clip_compress: true
clip_crf: 23                 # 18 = high quality, 23 = balanced, 28 = small
clip_fps: 30

# Hardware encoding (auto-detect GPU)
clip_hardware_encoding: true
# clip_encoder: auto          # Optional override:
#                             # h264_nvenc | h264_vaapi | h264_videotoolbox | libx264


# ─────────────────────────────────────────────────────────────────────────────
# Live Stream Ingestion
# ─────────────────────────────────────────────────────────────────────────────

# Buffer mode (recommended): Uses in-memory frame buffer
# - Perfect timing for clips
# - Records entire visits to video files
# - No tee or segment files needed
# - Memory usage: buffer_seconds × fps × ~100KB

# Tee mode (legacy/advanced): Uses ffmpeg tee with segment files
# - Required for 24-hour continuous recording of empty nest
# - More complex, may have timing issues
# live_use_ffmpeg_tee: true
# live_proxy_url: "udp://127.0.0.1:12345"
# buffer_dir: "/tmp/kanyo-buffer"
# continuous_chunk_minutes: 10

# max_runtime_seconds: 300    # Uncomment for test runs only


# ─────────────────────────────────────────────────────────────────────────────
# Logging
# ─────────────────────────────────────────────────────────────────────────────
# Log set to debug beecause GUI allows easy filtering
log_level: "DEBUG"             # DEBUG | INFO | WARNING | ERROR | CRITICAL


# ─────────────────────────────────────────────────────────────────────────────
# Notifications
# ─────────────────────────────────────────────────────────────────────────────

# Telegram notifications
telegram_enabled: true
telegram_channel: "@kanyo_example_channel"
# Bot token is provided via TELEGRAM_BOT_TOKEN env var

# ntfy (admin / error notifications only)
ntfy_admin_enabled: false
ntfy_topic: "kanyo_admin_errors"

# Cooldown between notifications (minutes)
notification_cooldown_minutes: 5


# ─────────────────────────────────────────────────────────────────────────────
# Display Metadata (for public viewer site)
# ─────────────────────────────────────────────────────────────────────────────
display:
  short_name: "My Cam"                    # Brief name for stream cards
  location: "City, State/Country"          # Full location description
  coordinates: [0.0, 0.0]                  # [latitude, longitude]
  species: "Peregrine Falcon (Falco peregrinus)"
  nest_status: "Active nesting site"      # Current status description
  maintainer: "Organization Name"          # Who maintains the camera
  maintainer_url: "https://example.com"    # Optional website link
  description: "Brief description of the camera location and purpose for public viewers."


# ============================================================================
# End of example config.yaml
# ============================================================================
